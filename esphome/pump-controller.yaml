esphome:
  name: hw-pump-controller
  friendly_name: HW Pump Controller
  on_boot:
    priority: 600
    then:
      - script.execute: led_sleep_all
      - script.execute: update
      - if:
          condition:
            lambda: 'return id(_boost_timer_remaining) > 0;'
          then:
            - script.execute: led_boost_on
      - if:
          condition:
            lambda: 'return id(_legionella_timer_remaining) > 0;'
          then:
            - script.execute: led_legionella_on

esp32:
  board: dfrobot_beetle_esp32c3
  variant: ESP32C3
  framework:
    type: esp-idf

logger:
  level: INFO

api:
  encryption:
    key: !secret esphome_hw_pump_api_key

ota:
  password: !secret esphome_hw_pump_ota_password

wifi:
  ssid: "IoT"
  password: !secret wifi_iot_password
  ap:
    ssid: "ESP-Pump-Controller"
    password: !secret esphome_hw_pump_ap_password
    ap_timeout: 60s

captive_portal:
web_server:

globals:
  - id: _boost_timer_remaining
    type: int
    restore_value: yes
    initial_value: "0"
  - id: _legionella_timer_remaining
    type: int
    restore_value: yes
    initial_value: "0"
  - id: _run_pump
    type: bool
    initial_value: "false"
  - id: _sensor_fail_counter
    type: int
    initial_value: "0"
  - id: _pump_max_runtime_counter
    type: int
    initial_value: "0"

number:
  - platform: template
    name: "Pump ΔT ON threshold"
    id: delta_on
    min_value: 5
    max_value: 30
    step: 1
    initial_value: 15
    unit_of_measurement: "°C"
  - platform: template
    name: "Pump ΔT OFF threshold"
    id: delta_off
    min_value: 0
    max_value: 25
    step: 1
    initial_value: 10
    unit_of_measurement: "°C"

script:
  # --- LED Helper Scripts ---
  - id: led_on
    parameters: [led]
    then:
      - lambda: 'led->turn_on().set_brightness(1).set_effect("None").perform();'

  - id: led_off
    parameters: [led]
    then:
      - lambda: 'led->turn_off().perform();'

  - id: led_sleep
    parameters: [led]
    then:
      - lambda: 'led->turn_on().set_effect("sleep").perform();'

  - id: led_sleep_all
    then:
      - script.execute: { id: led_sleep, led: !lambda "return &id(led2);" }
      - script.execute: { id: led_sleep, led: !lambda "return &id(led3);" }

  - id: led_boost_on
    then:
      - script.execute: { id: led_on, led: !lambda "return &id(led4);" }

  - id: led_legionella_on
    then:
      - script.execute: { id: led_on, led: !lambda "return &id(led5);" }

  # --- Boost Timer Scripts ---
  - id: start_boost_timer
    then:
      - script.execute: legionella_timer_off
      - lambda: 'id(_boost_timer_remaining) = 240;' # 4 minutes
      - script.execute: led_boost_on
      - script.execute: update

  - id: boost_timer_off
    then:
      - lambda: 'id(_boost_timer_remaining) = 0;'
      - script.execute: { id: led_off, led: !lambda "return &id(led4);" }
      - script.execute: update

  # --- Legionella Timer Scripts ---
  - id: start_legionella_timer
    then:
      - script.execute: boost_timer_off
      - lambda: 'id(_legionella_timer_remaining) = 360;' # 6 minutes
      - script.execute: led_legionella_on
      - script.execute: update

  - id: legionella_timer_off
    then:
      - lambda: 'id(_legionella_timer_remaining) = 0;'
      - script.execute: { id: led_off, led: !lambda "return &id(led5);" }
      - script.execute: update

  # --- Control Logic ---
  - id: update
    then:
      - lambda: |-
          id(_run_pump) =
            id(pump_control).state ||
            id(_boost_timer_remaining) > 0 ||
            id(_legionella_timer_remaining) > 0;

          if (id(_run_pump)) {
            id(led2).turn_on().perform();
            id(led3).turn_on().perform();
          } else {
            id(led2).turn_on().set_effect("sleep").perform();
            id(led3).turn_on().set_effect("sleep").perform();
          }
      - script.execute: update_pump_state

  - id: update_pump_state
    then:
      - lambda: |-
          if (!id(_run_pump)) {
            id(_pump_control).turn_off();
            id(led1).turn_off().perform();
            return;
          }

          // Sensor failure detection
          if (isnan(id(flow_temperature).state) ||
              isnan(id(pump_temperature).state)) {
            if (++id(_sensor_fail_counter) > 60) {
              ESP_LOGW("update_pump_state", "Sensors failed for 60s, forcing pump off.");
              id(_pump_control).turn_off();
            }
            // Use current_values check to avoid restarting the same effect repeatedly
            if (id(led1).current_values.get_effect_name() != "fast_flash") {
              id(led1).turn_on().set_effect("fast_flash").perform();
            }
            return;
          }

          id(_sensor_fail_counter) = 0;
          // Correct LED state immediately after sensor recovery
          if (id(_pump_control).state && id(led1).current_values.get_effect_name() != "flash") {
            id(led1).turn_on().set_effect("flash").perform();
          }

          float d = id(flow_temperature).state - id(pump_temperature).state;

          if (d > id(delta_on).state && !id(_pump_control).state) {
            ESP_LOGI("update_pump_state", "Temp delta (%.2f) > delta_on (%.0f), turning ON.", d, id(delta_on).state);
            id(_pump_control).turn_on();
            // Optimization: avoid LED churn
            if (id(led1).current_values.get_effect_name() != "flash") {
              id(led1).turn_on().set_effect("flash").perform();
            }
          } else if (d < id(delta_off).state && id(_pump_control).state) {
            ESP_LOGI("update_pump_state", "Temp delta (%.2f) < delta_off (%.0f), turning OFF.", d, id(delta_off).state);
            id(_pump_control).turn_off();
            id(led1).turn_off().perform();
          } else if (id(_pump_control).state && !id(led1).current_values.is_on()) {
            // Pump is on, but LED1 is not. Turn it on.
            if (id(led1).current_values.get_effect_name() != "flash") {
              id(led1).turn_on().set_effect("flash").perform();
            }
          } else if (!id(_pump_control).state && id(led1).current_values.is_on()) {
             // Pump is off, but LED1 is on. Turn it off.
             id(led1).turn_off().perform();
          }

interval:
  - interval: 1s
    then:
      # 1. Pump Max Runtime Limiter (10 minutes/600s)
      - if:
          condition:
            lambda: 'return id(_pump_control).state;'
          then:
            - lambda: |-
                if (++id(_pump_max_runtime_counter) > 600) {
                  ESP_LOGW("interval", "Pump max runtime exceeded, forcing turn off.");
                  id(_pump_control).turn_off();
                  id(_pump_max_runtime_counter) = 0; // FIXED: Counter reset on forced OFF
                }
          else:
            - lambda: 'id(_pump_max_runtime_counter) = 0;'

      # 2. Boost Timer Tick Logic
      - if:
          condition:
            lambda: 'return id(_boost_timer_remaining) > 0;'
          then:
            - lambda: |-
                if (--id(_boost_timer_remaining) <= 0)
                  id(boost_timer_off).execute();

      # 3. Legionella Timer Tick Logic
      - if:
          condition:
            lambda: 'return id(_legionella_timer_remaining) > 0;'
          then:
            - lambda: |-
                if (--id(_legionella_timer_remaining) <= 0)
                  id(legionella_timer_off).execute();

light:
  - platform: monochromatic
    id: led1
    output: led1_output
    effects:
      - pulse:
          name: flash
          transition_length: 0s
          update_interval: 0.75s
      - pulse:
          name: fast_flash
          transition_length: 0s
          update_interval: 0.25s

  - platform: monochromatic
    id: led2
    output: led2_output
    internal: true
    effects:
      - pulse:
          name: sleep
          transition_length: 2s
          update_interval: 2s
          min_brightness: 10%
          max_brightness: 40%

  - platform: monochromatic
    id: led3
    output: led3_output
    internal: true
    effects:
      - pulse:
          name: sleep
          transition_length: 2s
          update_interval: 2s
          min_brightness: 10%
          max_brightness: 40%

  - platform: monochromatic
    id: led4
    output: led4_output
    internal: true

  - platform: monochromatic
    id: led5
    output: led5_output
    internal: true

output:
  - platform: ledc
    pin: 5
    id: led1_output
  - platform: ledc
    pin: 18
    id: led2_output
  - platform: ledc
    pin: 6
    id: led3_output
  - platform: ledc
    pin: 7
    id: led4_output
  - platform: ledc
    pin: 3
    id: led5_output

button:
  - platform: template
    name: "Boost pump"
    on_press:
      - script.execute: start_boost_timer
  - platform: template
    name: "Legionella flush"
    on_press:
      - script.execute: start_legionella_timer

binary_sensor:
  - platform: gpio
    name: "Pump Button"
    pin:
      number: 9
      mode:
        input: true
        pullup: true
      inverted: true
    on_click:
      - min_length: 50ms
        max_length: 1s
        then:
          - script.execute: start_boost_timer
      - min_length: 3s
        max_length: 10s
        then:
          - script.execute: start_legionella_timer

  - platform: template
    id: pump_state
    name: "Pump State"
    device_class: running

switch:
  - platform: gpio
    id: _pump_control
    pin:
      number: 10
      inverted: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - binary_sensor.template.publish:
          id: pump_state
          state: true
    on_turn_off:
      - binary_sensor.template.publish:
          id: pump_state
          state: false

  - platform: template
    id: pump_control
    name: "Pump"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - script.execute: update
    turn_off_action:
      - script.execute: update

sensor:
  - platform: template
    name: "Boost timer"
    unit_of_measurement: "min"
    update_interval: 10s
    lambda: 'return round(id(_boost_timer_remaining) / 60.0f);'

  - platform: template
    name: "Legionella timer"
    unit_of_measurement: "min"
    update_interval: 10s
    lambda: 'return round(id(_legionella_timer_remaining) / 60.0f);'

  - platform: ntc
    id: flow_temperature
    name: "Flow Temperature"
    sensor: flow_temp_resistance
    calibration:
      b_constant: 3950
      reference_temperature: 25°C
      reference_resistance: 10kOhm
    on_value:
      - script.execute: update_pump_state

  - platform: resistance
    id: flow_temp_resistance
    sensor: flow_temp_adc
    configuration: DOWNSTREAM
    resistor: 10kOhm
    internal: true

  - platform: adc
    id: flow_temp_adc
    pin: 4
    attenuation: auto
    update_interval: 1s
    filters:
      - sliding_window_moving_average:
          window_size: 10
          send_every: 10
    internal: true

  - platform: adc
    id: pump_temp_adc
    pin: 1
    attenuation: auto
    update_interval: 1s
    filters:
      - sliding_window_moving_average:
          window_size: 10
          send_every: 10
    internal: true

  - platform: template
    id: pump_temperature
    name: "Pump Temperature"
    unit_of_measurement: "°C"
    lambda: 'return id(pump_temp_adc).state;'
    filters:
      - unique:
      - throttle_average: 10s
      - calibrate_linear:
          datapoints:
            - 0.61 -> 55
            - 0.83 -> 35
            - 0.84 -> 33
            - 0.85 -> 31
            - 0.90 -> 25
    on_value:
      - script.execute: update_pump_state
